<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Minesweeper</title>

  <style>
    button {
      background-color: gray;
      height:20px;
    }
  </style>
</head>

<body>

    <table id="board" style="border: 1px solid black">
    </table>
  <script>
    const discoveredCells = 0
    let boardSize = 0
    async function getBoard() {
      const response = await fetch("/game/board/");
      return response.json();
    }
    getBoard().then(config => {
      const table = document.getElementById("board")
      let currentTr = document.createElement("tr")
      boardSize = config.size;
      for(let i=0; i< boardSize; i++){
        currentTr = document.createElement("tr");
        table.appendChild(currentTr)

        for(let j=0; j < boardSize; j++) {
          const td = document.createElement("td")
          currentTr.appendChild(td)
          const button = document.createElement("button")
          button.setAttribute("data-x", i)
          button.setAttribute("data-y", j)
          button.setAttribute("onClick", "handleClick(event)")
          td.appendChild(button)
        }

      }
    })

    async function handleClick(event){
      const pressedCell = event.target;
      const x = pressedCell.dataset.x;
      const y = pressedCell.dataset.y;
      const response = await fetch('/game/click/', {
        method: 'POST',
        body: JSON.stringify({x, y}),
        headers:{
          'Content-Type': 'application/json'
        }
      });
       if (response.status === 400){
          pressedCell.style.backgroundColor = 'red'
          alert("You lost :(")
          const buttons = document.getElementsByTagName("button")
          for (button of buttons) {
            button.setAttribute("disabled", "")
          }
       } else {
        // add adjacents and pressed cell as green and to the discovered cells
        const data = await response.json()
        debugger
        const table = document.getElementById("board")
        data.forEach(coords => {
          const trs = table.getElementsByTagName("tr");
          const tr = trs[coords[0]];
          const tds = tr.getElementsByTagName("td");
          const td = tds[coords[1]];
          td.style.backgroundColor = "green";
        }

        )

         pressedCell.style.backgroundColor = 'green'
         if (discoveredCells === boardSize * boardSize) {
           alert("You won :)")
         }
       }
    }
  </script>
</body>
</html>